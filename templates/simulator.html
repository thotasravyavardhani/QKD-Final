<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BB84 Simulator - QuantumBB84</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/style.css">
    
    <!-- Tailwind configuration with Google Cloud colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#1A73E8',
                        'accent-blue': '#4285F4',
                        'success-green': '#0F9D58',
                        'warning-yellow': '#F4B400',
                        'danger-red': '#DB4437',
                        'neutral-bg': '#F5F5F5',
                        'neutral-bg-dark': '#E0E0E0',
                        'text-primary': '#3C4043'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-neutral-bg text-text-primary">
    
    {% include 'header.html' %}
    
    <!-- Main Simulator Content -->
    <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="flex gap-6 h-[calc(100vh-120px)]">
            
            <!-- Simulator Control Sidebar -->
            <div class="w-80 bg-white rounded-lg shadow-sm border border-neutral-bg-dark overflow-y-auto">
                <div class="p-6">
                    <h2 class="text-lg font-semibold text-text-primary mb-6 flex items-center">
                        <i data-feather="settings" class="w-5 h-5 mr-2 text-primary-blue"></i>
                        Simulation Parameters
                    </h2>
                    
                    <!-- Backend Selection -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-text-primary mb-3">Backend Selection</label>
                        <div class="space-y-2">
                            <label class="flex items-center p-3 rounded-lg border border-gray-200 hover:bg-blue-50 cursor-pointer">
                                <input type="radio" name="backend" value="classical" checked class="text-primary-blue">
                                <div class="ml-3">
                                    <span class="text-sm font-medium">Classical Mathematical</span>
                                    <span class="block text-xs text-gray-500">(1-32 qubits)</span>
                                </div>
                            </label>
                            <label class="flex items-center p-3 rounded-lg border border-gray-200 hover:bg-blue-50 cursor-pointer">
                                <input type="radio" name="backend" value="qiskit" class="text-primary-blue">
                                <div class="ml-3">
                                    <span class="text-sm font-medium">Qiskit IBM Simulator</span>
                                    <span class="block text-xs text-gray-500">(1-32 qubits)</span>
                                </div>
                            </label>
                            <label class="flex items-center p-3 rounded-lg border border-gray-200 hover:bg-blue-50 cursor-pointer">
                                <input type="radio" name="backend" value="real_quantum" class="text-primary-blue">
                                <div class="ml-3">
                                    <span class="text-sm font-medium">Real Quantum Computer</span>
                                    <span class="block text-xs text-danger-red">(3-4 qubits only)</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Qubit Generation (for Classical and Qiskit backends only) -->
                    <div id="qubitGenerationSection" class="mb-6">
                        <label class="block text-sm font-medium text-text-primary mb-3">Qubit Generation</label>
                        <div class="space-y-2">
                            <label class="flex items-center p-3 rounded-lg border border-gray-200 hover:bg-blue-50 cursor-pointer">
                                <input type="radio" name="scenario" value="manual" checked class="text-primary-blue">
                                <span class="ml-2 text-sm">Manual Input</span>
                            </label>
                            <label class="flex items-center p-3 rounded-lg border border-gray-200 hover:bg-blue-50 cursor-pointer">
                                <input type="radio" name="scenario" value="auto" class="text-primary-blue">
                                <span class="ml-2 text-sm">Auto-Generated</span>
                            </label>
                        </div>
                        
                        <!-- Nested Auto-Generation Options -->
                        <div id="autoGenerationOptions" class="mt-4 ml-4 space-y-2 hidden">
                            <label class="flex items-center p-2 rounded-lg border border-gray-100 hover:bg-gray-50 cursor-pointer">
                                <input type="radio" name="autoType" value="qubits" checked class="text-primary-blue">
                                <span class="ml-2 text-sm">Number of Qubits</span>
                            </label>
                            <label class="flex items-center p-2 rounded-lg border border-gray-100 hover:bg-gray-50 cursor-pointer">
                                <input type="radio" name="autoType" value="photon" class="text-primary-blue">
                                <span class="ml-2 text-sm">Photon Rate Based</span>
                            </label>
                        </div>
                    </div>

                    <!-- IBM Quantum API Key (for Real Quantum Computer only) -->
                    <div id="quantumApiSection" class="mb-6 hidden">
                        <label class="block text-sm font-medium text-text-primary mb-3">
                            <i data-feather="key" class="w-4 h-4 inline mr-1"></i>
                            IBM Quantum API Key
                        </label>
                        <input type="password" id="quantumApiKey" placeholder="Enter your IBM Quantum API Key" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-blue focus:border-transparent">
                        <p class="text-xs text-gray-500 mt-1">‚ö° Required for real quantum device testing (3-4 qubits max)</p>
                        <p class="text-xs text-warning-yellow mt-1">‚è±Ô∏è Note: Real quantum jobs may take 2-5 minutes to complete</p>
                    </div>

                    <!-- Scenario Presets -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-text-primary mb-2">Quick Scenarios</label>
                        <select id="scenarioPreset" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-blue focus:border-transparent">
                            <option value="">Select a preset...</option>
                            <option value="secure_short">Secure Short Distance</option>
                            <option value="noisy_channel">Noisy Channel Test</option>
                            <option value="eve_attack">Eve Attack Simulation</option>
                            <option value="high_rate">High Key Rate</option>
                        </select>
                    </div>

                    <!-- Run Simulation Button -->
                    <button id="runSimulation" class="w-full bg-primary-blue text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition-all duration-200 shadow-lg flex items-center justify-center">
                        <i data-feather="play" class="w-4 h-4 mr-2"></i>
                        Run Simulation
                    </button>
                </div>
            </div>

            <!-- Main Simulation Area -->
            <div class="flex-1 space-y-4 overflow-y-auto">
                <!-- Manual Input Section -->
                <div id="manualInputSection" class="bg-white rounded-lg shadow-sm border border-neutral-bg-dark p-6">
                    <h3 class="text-lg font-semibold text-text-primary mb-4 flex items-center">
                        <i data-feather="edit-3" class="w-5 h-5 mr-2 text-primary-blue"></i>
                        Manual Quantum State Input
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">Alice's Bits</label>
                            <input type="text" id="aliceBits" value="0110" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-blue focus:border-transparent font-mono">
                            <p class="text-xs text-gray-500 mt-1">Binary string (0s and 1s)</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">Alice's Bases</label>
                            <input type="text" id="aliceBases" value="+x+x" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-blue focus:border-transparent font-mono">
                            <p class="text-xs text-gray-500 mt-1">Measurement bases (+ or x)</p>
                        </div>
                    </div>
                </div>

                <!-- Number of Qubits Section -->
                <div id="numQubitsSection" class="bg-white rounded-lg shadow-sm border border-neutral-bg-dark p-6 hidden">
                    <h3 class="text-lg font-semibold text-text-primary mb-4 flex items-center">
                        <i data-feather="cpu" class="w-5 h-5 mr-2 text-primary-blue"></i>
                        Number of Qubits Generation
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">Number of Qubits</label>
                            <input type="range" id="numQubits" min="4" max="32" value="8" class="w-full">
                            <span id="numQubitsValue" class="text-sm text-gray-600">8</span>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">RNG Type</label>
                            <select id="rngType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-blue focus:border-transparent">
                                <option value="classical">Classical PRNG</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Photon Rate Based Section -->
                <div id="photonRateSection" class="bg-white rounded-lg shadow-sm border border-neutral-bg-dark p-6 hidden">
                    <h3 class="text-lg font-semibold text-text-primary mb-4 flex items-center">
                        <i data-feather="zap" class="w-5 h-5 mr-2 text-warning-yellow"></i>
                        Photon Rate Based Generation
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">Photon Rate (MHz)</label>
                            <input type="range" id="photonRate" min="10" max="1000" value="100" class="w-full">
                            <span id="photonRateValue" class="text-sm text-gray-600">100</span>
                        </div>
                        <div class="flex items-center">
                            <div class="bg-yellow-50 rounded-lg p-4 border border-yellow-200">
                                <p class="text-sm text-yellow-800">
                                    <i data-feather="info" class="w-4 h-4 inline mr-1"></i>
                                    Continuous streaming mode - simulation runs until stopped
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Security Parameters -->
                <div class="bg-white rounded-lg shadow-sm border border-neutral-bg-dark p-6">
                    <h3 class="text-lg font-semibold text-text-primary mb-4 flex items-center">
                        <i data-feather="shield" class="w-5 h-5 mr-2 text-success-green"></i>
                        Security & Channel Parameters
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">Distance (km)</label>
                            <input type="range" id="distance" min="0.1" max="100" value="10" step="0.1" class="w-full">
                            <span id="distanceValue" class="text-sm text-gray-600">10 km</span>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">Channel Noise</label>
                            <input type="range" id="noise" min="0" max="0.5" value="0.1" step="0.01" class="w-full">
                            <span id="noiseValue" class="text-sm text-gray-600">0.1</span>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">Eve Attack</label>
                            <select id="eveAttack" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-blue focus:border-transparent text-sm">
                                <option value="none">None</option>
                                <option value="intercept_resend">Intercept-Resend</option>
                                <option value="beam_splitting">Beam Splitting</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">Error Correction</label>
                            <select id="errorCorrection" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-blue focus:border-transparent text-sm">
                                <option value="none">None</option>
                                <option value="cascade">Cascade</option>
                                <option value="winnow">Winnow</option>
                                <option value="ldpc">LDPC</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">Privacy Amplification</label>
                            <select id="privacyAmplification" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-blue focus:border-transparent text-sm">
                                <option value="none">None</option>
                                <option value="standard">Standard</option>
                                <option value="universal">Universal Hashing</option>
                                <option value="toeplitz">Toeplitz Matrix</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Simulation Results -->
                <div id="simulationResults" class="bg-white rounded-lg shadow-sm border border-neutral-bg-dark p-6 hidden">
                    <h3 class="text-lg font-semibold text-text-primary mb-4 flex items-center">
                        <i data-feather="bar-chart-2" class="w-5 h-5 mr-2 text-success-green"></i>
                        Simulation Results
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                        <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">QBER</p>
                                    <p id="qberResult" class="text-2xl font-bold text-primary-blue">-</p>
                                </div>
                                <div class="w-10 h-10 bg-primary-blue rounded-lg flex items-center justify-center">
                                    <i data-feather="alert-triangle" class="w-5 h-5 text-white"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Security Status</p>
                                    <p id="securityResult" class="text-lg font-bold text-success-green">-</p>
                                </div>
                                <div class="w-10 h-10 bg-success-green rounded-lg flex items-center justify-center">
                                    <i data-feather="shield" class="w-5 h-5 text-white"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-yellow-50 rounded-lg p-4 border border-yellow-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Key Rate</p>
                                    <p id="keyRateResult" class="text-lg font-bold text-warning-yellow">-</p>
                                </div>
                                <div class="w-10 h-10 bg-warning-yellow rounded-lg flex items-center justify-center">
                                    <i data-feather="key" class="w-5 h-5 text-white"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4 border border-purple-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Final Key Length</p>
                                    <p id="keyLengthResult" class="text-lg font-bold text-purple-600">-</p>
                                </div>
                                <div class="w-10 h-10 bg-purple-600 rounded-lg flex items-center justify-center">
                                    <i data-feather="layers" class="w-5 h-5 text-white"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- üéå Quantum vs Classical Performance Analysis -->
                    <div class="bg-gradient-to-r from-pink-50 via-purple-50 to-blue-50 rounded-xl p-6 mb-6 border-2 border-pink-200">
                        <h4 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-blue-500 mb-6 flex items-center">
                            <span class="text-2xl mr-3">‚öõÔ∏èüíª</span>
                            Quantum vs Classical Performance Battle
                        </h4>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                            <!-- Speed Comparison Radar -->
                            <div class="bg-white rounded-xl p-4 shadow-lg border-2 border-pink-100 hover:shadow-xl transition-all">
                                <h5 class="font-bold text-gray-800 mb-3 flex items-center">
                                    <span class="text-lg mr-2">üöÄ</span>
                                    Speed Comparison
                                </h5>
                                <div class="h-64 relative">
                                    <canvas id="speedComparisonChart"></canvas>
                                </div>
                            </div>
                            
                            <!-- Reliability Pie Chart -->
                            <div class="bg-white rounded-xl p-4 shadow-lg border-2 border-blue-100 hover:shadow-xl transition-all">
                                <h5 class="font-bold text-gray-800 mb-3 flex items-center">
                                    <span class="text-lg mr-2">üç©</span>
                                    Reliability Analysis
                                </h5>
                                <div class="h-64 relative">
                                    <canvas id="reliabilityChart"></canvas>
                                </div>
                            </div>
                            
                            <!-- Efficiency vs Security Matrix -->
                            <div class="bg-white rounded-xl p-4 shadow-lg border-2 border-purple-100 hover:shadow-xl transition-all">
                                <h5 class="font-bold text-gray-800 mb-3 flex items-center">
                                    <span class="text-lg mr-2">üéØ</span>
                                    Efficiency vs Security
                                </h5>
                                <div class="h-64 relative">
                                    <canvas id="efficiencyMatrix"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Performance Dashboard -->
                        <div class="mt-6 bg-gradient-to-r from-gray-900 to-purple-900 rounded-xl p-6 text-white">
                            <h5 class="font-bold text-xl mb-4 flex items-center">
                                <span class="text-2xl mr-3">üìä</span>
                                Real-time Performance Dashboard
                            </h5>
                            <div class="h-48 relative">
                                <canvas id="performanceDashboard"></canvas>
                            </div>
                        </div>
                        
                        <!-- Anime-style Metrics Cards -->
                        <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-gradient-to-br from-pink-400 to-pink-600 rounded-xl p-4 text-white text-center">
                                <div class="text-2xl mb-2">‚öõÔ∏è</div>
                                <div class="text-2xl font-bold" id="quantumScore">95</div>
                                <div class="text-sm opacity-90">Quantum Score</div>
                            </div>
                            <div class="bg-gradient-to-br from-blue-400 to-blue-600 rounded-xl p-4 text-white text-center">
                                <div class="text-2xl mb-2">üíª</div>
                                <div class="text-2xl font-bold" id="classicalScore">87</div>
                                <div class="text-sm opacity-90">Classical Score</div>
                            </div>
                            <div class="bg-gradient-to-br from-purple-400 to-purple-600 rounded-xl p-4 text-white text-center">
                                <div class="text-2xl mb-2">üõ°Ô∏è</div>
                                <div class="text-2xl font-bold" id="securityLevel">98</div>
                                <div class="text-sm opacity-90">Security Level</div>
                            </div>
                            <div class="bg-gradient-to-br from-green-400 to-green-600 rounded-xl p-4 text-white text-center">
                                <div class="text-2xl mb-2">‚ö°</div>
                                <div class="text-2xl font-bold" id="speedIndex">92</div>
                                <div class="text-sm opacity-90">Speed Index</div>
                            </div>
                        </div>
                    </div>

                    <!-- Lab Metrics Section -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 mb-6 border border-blue-200">
                        <h4 class="text-lg font-semibold text-text-primary mb-4 flex items-center">
                            <i data-feather="activity" class="w-5 h-5 mr-2 text-primary-blue"></i>
                            Laboratory Metrics & Analysis
                        </h4>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Real-time QBER Chart -->
                            <div class="bg-white rounded-lg p-4 shadow-sm">
                                <h5 class="font-medium text-gray-900 mb-3">QBER Analysis</h5>
                                <div class="h-48 relative">
                                    <canvas id="qberAnalysisChart"></canvas>
                                </div>
                                <div class="mt-3 flex items-center justify-between text-sm">
                                    <span class="text-gray-600">Security Threshold: 11%</span>
                                    <span id="currentQBER" class="font-medium text-primary-blue">Current: -</span>
                                </div>
                            </div>
                            
                            <!-- Key Generation Rate -->
                            <div class="bg-white rounded-lg p-4 shadow-sm">
                                <h5 class="font-medium text-gray-900 mb-3">Key Generation Rate</h5>
                                <div class="h-48 relative">
                                    <canvas id="keyRateChart"></canvas>
                                </div>
                                <div class="mt-3 flex items-center justify-between text-sm">
                                    <span class="text-gray-600">Target: >1 kbps</span>
                                    <span id="currentKeyRate" class="font-medium text-success-green">Current: -</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quantum Fidelity Metrics -->
                        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-white rounded-lg p-4 text-center shadow-sm">
                                <div class="text-2xl font-bold text-primary-blue mb-1" id="quantumFidelity">-</div>
                                <div class="text-sm text-gray-600">Quantum Fidelity</div>
                                <div class="mt-2 w-full bg-gray-200 rounded-full h-2">
                                    <div id="fidelityBar" class="bg-primary-blue h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg p-4 text-center shadow-sm">
                                <div class="text-2xl font-bold text-success-green mb-1" id="channelEfficiency">-</div>
                                <div class="text-sm text-gray-600">Channel Efficiency</div>
                                <div class="mt-2 w-full bg-gray-200 rounded-full h-2">
                                    <div id="efficiencyBar" class="bg-success-green h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg p-4 text-center shadow-sm">
                                <div class="text-2xl font-bold text-warning-yellow mb-1" id="errorRate">-</div>
                                <div class="text-sm text-gray-600">Error Rate</div>
                                <div class="mt-2 w-full bg-gray-200 rounded-full h-2">
                                    <div id="errorBar" class="bg-warning-yellow h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Transmission Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full" id="transmissionTable">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qubit #</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alice Bit</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alice Base</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bob Base</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bob Measurement</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Base Match</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Final Key</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="transmissionTableBody">
                                <tr>
                                    <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                                        <i data-feather="database" class="w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                                        <p>Run a simulation to see transmission data</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Quantum Circuit Diagrams Section -->
                <div id="circuitDiagrams" class="bg-white rounded-lg shadow-sm border border-neutral-bg-dark p-6 hidden">
                    <h3 class="text-lg font-semibold text-text-primary mb-4 flex items-center">
                        <i data-feather="cpu" class="w-5 h-5 mr-2 text-primary-blue"></i>
                        Quantum Circuit Visualization
                    </h3>
                    
                    <!-- Circuit Selection Controls -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">Circuit Type</label>
                            <select id="circuitType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-blue focus:border-transparent">
                                <option value="alice">Alice's Encoding</option>
                                <option value="bob">Bob's Measurement</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">Bit Value</label>
                            <select id="circuitBit" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-blue focus:border-transparent">
                                <option value="0">0</option>
                                <option value="1">1</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">Basis</label>
                            <select id="circuitBasis" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-blue focus:border-transparent">
                                <option value="+">+ (Rectilinear)</option>
                                <option value="x">√ó (Diagonal)</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button id="generateCircuit" class="w-full bg-primary-blue text-white py-2 px-4 rounded-lg font-medium hover:bg-blue-700 transition-all duration-200 flex items-center justify-center">
                                <i data-feather="zap" class="w-4 h-4 mr-2"></i>
                                Generate Circuit
                            </button>
                        </div>
                    </div>
                    
                    <!-- Circuit Display Area -->
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-6 border border-blue-200">
                        <div id="circuitDescription" class="text-center text-gray-600 mb-4">
                            Select parameters and click "Generate Circuit" to see the quantum circuit diagram
                        </div>
                        <div id="circuitImageContainer" class="text-center">
                            <img id="circuitImage" class="mx-auto max-w-full h-auto hidden" alt="Quantum Circuit Diagram">
                        </div>
                        <div id="circuitLoading" class="text-center py-8 hidden">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-blue mx-auto"></div>
                            <p class="text-gray-600 mt-4">Generating quantum circuit diagram...</p>
                        </div>
                    </div>
                    
                    <!-- Circuit Explanation -->
                    <div class="mt-6 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-4 border border-green-200">
                        <h4 class="font-semibold text-green-900 mb-2 flex items-center">
                            <i data-feather="info" class="w-4 h-4 mr-2"></i>
                            Circuit Explanation
                        </h4>
                        <div class="text-sm text-gray-700 space-y-2">
                            <p><strong>Alice's Encoding:</strong> Shows how a classical bit is converted to a quantum state using X (bit flip) and H (Hadamard) gates.</p>
                            <p><strong>Bob's Measurement:</strong> Shows how Bob measures the quantum state, applying H gate for diagonal basis before measurement.</p>
                            <p><strong>Basis:</strong> + (rectilinear) uses {|0‚ü©, |1‚ü©} states, √ó (diagonal) uses {|+‚ü©, |-‚ü©} states via Hadamard transformation.</p>
                        </div>
                    </div>
                </div>

                <!-- Animation Controls -->
                <div class="bg-white rounded-lg shadow-sm border border-neutral-bg-dark p-6">
                    <h3 class="text-lg font-semibold text-text-primary mb-4 flex items-center">
                        <i data-feather="play-circle" class="w-5 h-5 mr-2 text-primary-blue"></i>
                        Quantum Channel Animation
                    </h3>
                    
                    <div class="flex items-center space-x-4 mb-4">
                        <button id="playAnimation" class="bg-success-green text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center">
                            <i data-feather="play" class="w-4 h-4 mr-2"></i>
                            Play
                        </button>
                        <button id="pauseAnimation" class="bg-warning-yellow text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition-colors flex items-center">
                            <i data-feather="pause" class="w-4 h-4 mr-2"></i>
                            Pause
                        </button>
                        <button id="resetAnimation" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors flex items-center">
                            <i data-feather="refresh-cw" class="w-4 h-4 mr-2"></i>
                            Reset
                        </button>
                    </div>
                    
                    <div class="bg-gray-900 rounded-lg h-64 flex items-center justify-center" id="quantumAnimation">
                        <canvas id="animationCanvas" width="800" height="300" class="max-w-full max-h-full rounded-lg"></canvas>
                    </div>
                    
                    <div class="mt-4">
                        <input type="range" id="animationScrubber" min="0" max="100" value="0" class="w-full">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>Start</span>
                            <span>Progress</span>
                            <span>Complete</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
        <div class="flex items-center justify-center h-full">
            <div class="bg-white rounded-xl p-8 max-w-md mx-4">
                <div class="text-center">
                    <div class="w-16 h-16 border-4 border-primary-blue border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                    <h3 class="text-lg font-semibold text-text-primary mb-2">Processing Quantum Operations</h3>
                    <p id="loadingMessage" class="text-gray-600">Initializing simulation...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/static/app.js"></script>
    <script src="/static/visualization.js"></script>
    <script src="/static/ui-fix.js"></script>
    
    <!-- Enhanced Lab Metrics Script -->
    <script>
        // Lab metrics initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize lab charts
            initializeLabCharts();
            
            // Add animation to metrics bars
            animateMetricsBars();
        });
        
        function initializeLabCharts() {
            // QBER Analysis Chart
            const qberCanvas = document.getElementById('qberAnalysisChart');
            if (qberCanvas) {
                window.qberAnalysisChart = new Chart(qberCanvas, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'QBER (%)',
                            data: [],
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Security Threshold',
                            data: [],
                            borderColor: '#f59e0b',
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 25,
                                title: {
                                    display: true,
                                    text: 'QBER (%)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        }
                    }
                });
            }
            
            // Key Rate Chart
            const keyRateCanvas = document.getElementById('keyRateChart');
            if (keyRateCanvas) {
                window.keyRateChart = new Chart(keyRateCanvas, {
                    type: 'bar',
                    data: {
                        labels: ['Current Session'],
                        datasets: [{
                            label: 'Key Rate (kbps)',
                            data: [0],
                            backgroundColor: 'rgba(34, 197, 94, 0.8)',
                            borderColor: '#22c55e',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Key Rate (kbps)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
        }
        
        function animateMetricsBars() {
            // Add pulsing animation to metric bars
            const bars = ['fidelityBar', 'efficiencyBar', 'errorBar'];
            bars.forEach(barId => {
                const bar = document.getElementById(barId);
                if (bar) {
                    bar.style.transition = 'width 1s ease-in-out';
                }
            });
        }
        
        // Update lab metrics when simulation completes
        function updateLabMetrics(result) {
            // Update QBER analysis
            if (window.qberAnalysisChart) {
                const qber = (result.qber * 100).toFixed(2);
                const timestamp = new Date().toLocaleTimeString();
                
                window.qberAnalysisChart.data.labels.push(timestamp);
                window.qberAnalysisChart.data.datasets[0].data.push(qber);
                window.qberAnalysisChart.data.datasets[1].data.push(11); // Security threshold
                
                // Keep only last 10 points
                if (window.qberAnalysisChart.data.labels.length > 10) {
                    window.qberAnalysisChart.data.labels.shift();
                    window.qberAnalysisChart.data.datasets[0].data.shift();
                    window.qberAnalysisChart.data.datasets[1].data.shift();
                }
                
                window.qberAnalysisChart.update();
                
                // Update current QBER display
                const currentQBER = document.getElementById('currentQBER');
                if (currentQBER) {
                    currentQBER.textContent = `Current: ${qber}%`;
                    currentQBER.className = qber > 11 ? 'font-medium text-red-600' : 'font-medium text-green-600';
                }
            }
            
            // Update key rate chart
            if (window.keyRateChart) {
                const keyRate = result.key_generation_rate || 0;
                window.keyRateChart.data.datasets[0].data[0] = keyRate;
                window.keyRateChart.update();
                
                // Update current key rate display
                const currentKeyRate = document.getElementById('currentKeyRate');
                if (currentKeyRate) {
                    currentKeyRate.textContent = `Current: ${keyRate.toFixed(2)} kbps`;
                }
            }
            
            // Update quantum metrics
            const fidelity = result.classical_fidelity || result.simulator_fidelity || result.device_fidelity || 0;
            const efficiency = result.key_accuracy || 0;
            const errorRate = result.qber || 0;
            
            // Update fidelity
            const quantumFidelity = document.getElementById('quantumFidelity');
            const fidelityBar = document.getElementById('fidelityBar');
            if (quantumFidelity && fidelityBar) {
                quantumFidelity.textContent = (fidelity * 100).toFixed(1) + '%';
                fidelityBar.style.width = (fidelity * 100) + '%';
            }
            
            // Update efficiency
            const channelEfficiency = document.getElementById('channelEfficiency');
            const efficiencyBar = document.getElementById('efficiencyBar');
            if (channelEfficiency && efficiencyBar) {
                channelEfficiency.textContent = (efficiency * 100).toFixed(1) + '%';
                efficiencyBar.style.width = (efficiency * 100) + '%';
            }
            
            // Update error rate
            const errorRateEl = document.getElementById('errorRate');
            const errorBar = document.getElementById('errorBar');
            if (errorRateEl && errorBar) {
                errorRateEl.textContent = (errorRate * 100).toFixed(2) + '%';
                errorBar.style.width = Math.min(errorRate * 100 * 4, 100) + '%'; // Scale for visibility
            }
        }
    </script>
    
    <!-- Initialize Feather Icons -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            feather.replace();
            
            // CRITICAL FIX: Show/hide API key field based on backend selection
            function toggleApiKeyField() {
                const realQuantumSelected = document.querySelector('input[name="backend"][value="real_quantum"]:checked');
                const apiSection = document.getElementById('quantumApiSection');
                
                if (realQuantumSelected && apiSection) {
                    apiSection.classList.remove('hidden');
                    console.log('‚úÖ API key field shown');
                } else if (apiSection) {
                    apiSection.classList.add('hidden');
                }
            }
            
            // Add event listeners to all backend radio buttons
            document.querySelectorAll('input[name="backend"]').forEach(radio => {
                radio.addEventListener('change', toggleApiKeyField);
            });
            
            // Check initial state
            setTimeout(toggleApiKeyField, 100);
        });
    </script>
    
    <!-- Add CSS for progress bar animations -->
    <style>
        .progress-bar-animation {
            background: linear-gradient(-45deg, #1A73E8, #4285F4, #6A8EDB, #9C27B0);
            background-size: 400% 400%;
            animation: gradientShift 2s ease infinite;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .quantum-glow {
            box-shadow: 0 0 20px rgba(26, 115, 232, 0.3);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(26, 115, 232, 0.3); }
            50% { box-shadow: 0 0 30px rgba(26, 115, 232, 0.6); }
        }
    </style>
</body>
</html>